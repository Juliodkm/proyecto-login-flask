<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Dashboard</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 20px;
            background-color: #121212;
            color: #e0e0e0;
        }
        .container {
            max-width: 800px;
            margin: 20px auto;
            background-color: #1e1e1e;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        h2, h3 {
            color: #ffffff;
            border-bottom: 2px solid #444;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        a {
            color: #bb86fc;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        .logout-link {
            display: inline-block;
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #6200ee;
            color: white;
            border-radius: 5px;
        }
        .btn {
            color: #000000;
            padding: 15px 30px;
            font-size: 18px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            margin: 10px;
        }
        .btn:hover { transform: translateY(-2px); }
        
        #checkin-btn { background-color: #03dac6; }
        #checkin-btn:disabled { background-color: #555; cursor: not-allowed; }
        #overtime-btn { background-color: #bb86fc; }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .stat-card {
            background-color: #2c2c2c;
            padding: 20px;
            border-radius: 8px;
        }
        .stat-card h4 { margin-top: 0; color: #03dac6; }
        .stat-card p { font-size: 24px; font-weight: bold; margin-bottom: 0; }

        /* Modal Styles */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1; 
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto; 
            background-color: rgba(0,0,0,0.8);
        }
        .modal-content {
            background-color: #2c2c2c;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 10px;
            text-align: center;
        }
        #video {
            width: 100%;
            height: auto;
            border-radius: 8px;
            background-color: #000;
        }
        .modal-btn {
            padding: 10px 20px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-size: 16px;
            margin: 10px;
        }
        #capture-btn { background-color: #03dac6; color: #000; }
        #cancel-btn { background-color: #cf6679; color: #000; }
        /* Check-in Table */
        .checkin-table {
            width: 100%;
            margin-top: 30px;
            border-collapse: collapse;
        }
        .checkin-table th, .checkin-table td {
            border: 1px solid #444;
            padding: 12px;
            text-align: left;
        }
        .checkin-table th {
            background-color: #333;
            color: #03dac6;
        }
        .checkin-table img {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>¡Bienvenido, {{ user.nombres }}!</h2>
        
        <div class="controls">
            <button id="checkin-btn" class="btn" data-tipo="{{ proximo_tipo_marcacion }}" {% if proximo_tipo_marcacion == 'Finalizado' %}disabled{% endif %}>
                Marcar {{ proximo_tipo_marcacion }}
            </button>
            <button id="overtime-btn" class="btn">Registrar Horas Extras</button>
        </div>

        <h3>Resumen del Mes</h3>
        <div class="stats-grid">
            <div class="stat-card">
                <h4>Días Puntuales</h4>
                <p>{{ dias_puntuales }}</p>
            </div>
            <div class="stat-card">
                <h4>Días con Tardanza</h4>
                <p>{{ dias_tarde }}</p>
            </div>
            <div class="stat-card">
                <h4>Almuerzos Largos</h4>
                <p>{{ dias_almuerzo_extendido }}</p>
            </div>
            <div class="stat-card">
                <h4>Horas Extras (Mes)</h4>
                <p>{{ horas_extras_mes }}</p>
            </div>
        </div>

        <div id="checkin-history">
            <h3>Mis Marcaciones de Hoy</h3>
            <table class="checkin-table" id="checkin-log">
                <thead>
                    <tr>
                        <th>Tipo</th>
                        <th>Hora</th>
                        <th>Estado</th>
                        <th>Foto</th>
                    </tr>
                </thead>
                <tbody>
                    {% for checkin in checkins %}
                    <tr>
                        <td>{{ checkin.tipo }}</td>
                        <td>{{ checkin.timestamp_peru.strftime('%H:%M:%S') }}</td>
                        <td>{{ checkin.status }}</td>
                        <td><img src="{{ url_for('uploaded_file', filename=checkin.photo_filename) }}" alt="Foto de marcación"></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <a href="{{ url_for('logout') }}" class="logout-link">Cerrar Sesión</a>
    </div>

    <!-- The Modal -->
    <div id="checkin-modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title">Registro de Marcación</h3>
            <p id="modal-message">Por favor, permite el acceso a tu cámara y ubicación.</p>
            <video id="video" autoplay></video>
            <canvas id="canvas" style="display:none;"></canvas>
            <div>
                <button id="capture-btn" class="modal-btn" disabled>Marcar Ahora</button>
                <button id="cancel-btn" class="modal-btn">Cancelar</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('checkin-modal');
    const checkinBtn = document.getElementById('checkin-btn');
    const overtimeBtn = document.getElementById('overtime-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const captureBtn = document.getElementById('capture-btn');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const modalMessage = document.getElementById('modal-message');
    const modalTitle = document.getElementById('modal-title');
    let stream = null;
    let currentCheckinType = '';

    checkinBtn.onclick = function() {
        currentCheckinType = this.dataset.tipo;
        if (currentCheckinType === 'Finalizado') return;
        
        modalTitle.textContent = `Registrar ${currentCheckinType}`;
        openModal();
    };

    overtimeBtn.onclick = async function() {
        const hours = prompt("Por favor, ingresa la cantidad de horas extras trabajadas hoy:");
        if (hours === null || hours.trim() === "") {
            alert("Registro de horas extras cancelado.");
            return;
        }

        try {
            const response = await fetch('{{ url_for("marcar_horas_extras") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ horas: hours })
            });
            const result = await response.json();
            alert(result.message);
            if (result.status === 'success') {
                location.reload(); // Recargar para ver las horas actualizadas
            }
        } catch (error) {
            console.error('Error al registrar horas extras:', error);
            alert('Error al registrar horas extras.');
        }
    };

    async function openModal() {
        modal.style.display = 'block';
        captureBtn.disabled = true;
        modalMessage.textContent = 'Iniciando cámara y solicitando permisos...';
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                captureBtn.disabled = false;
                modalMessage.textContent = 'Sonríe y presiona "Marcar Ahora".';
            };
        } catch (err) {
            console.error("Error de acceso a medios: ", err);
            modalMessage.textContent = `Error: ${err.name}. Asegúrate de haber dado permisos.`;
        }
    }

    cancelBtn.onclick = function() {
        closeModal();
    }

    window.onclick = function(event) {
        if (event.target == modal) {
            closeModal();
        }
    }

    function closeModal() {
        modal.style.display = 'none';
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
    }

    captureBtn.onclick = function() {
        modalMessage.textContent = 'Obteniendo ubicación y procesando...';
        captureBtn.disabled = true;
        
        navigator.geolocation.getCurrentPosition(async (position) => {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imgDataUrl = canvas.toDataURL('image/jpeg');

            try {
                const response = await fetch('{{ url_for("main.checkin") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        lat: lat, 
                        lon: lon, 
                        img: imgDataUrl, 
                        tipo: currentCheckinType 
                    })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    modalMessage.textContent = result.message;
                    setTimeout(() => location.reload(), 1500); // Recargar la página para ver todo actualizado
                } else {
                    throw new Error(result.message || 'Error desconocido del servidor.');
                }

            } catch (error) {
                console.error('Error al enviar la marcación:', error);
                modalMessage.textContent = `Error: ${error.message}`;
                captureBtn.disabled = false; // Reactivar si hay error
            }

        }, (error) => {
            console.error("Error de geolocalización: ", error);
            modalMessage.textContent = `Error de ubicación: ${error.message}`;
            captureBtn.disabled = false;
        });
    };
});
</script>

</body>
</html>
